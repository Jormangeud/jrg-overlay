--- samba-4.2.0.ebuild 2015-05-26 20:06:38.164636594 -0400
+++ samba-4.2.0.ebuild      2015-05-26 20:54:13.077598174 -0400
@@ -21,12 +21,11 @@
 SLOT="0"
 
 IUSE="acl addns ads aio avahi client cluster cups dmapi fam gnutls iprint
-ldap quota selinux syslog systemd test winbind"
+ldap quota selinux syslog +system-heimdal systemd test winbind"
 
 # sys-apps/attr is an automagic dependency (see bug #489748)
 # sys-libs/pam is an automagic dependency (see bug #489770)
 CDEPEND="${PYTHON_DEPS}
-       >=app-crypt/heimdal-1.5[-ssl]
        dev-libs/iniparser
        dev-libs/popt
        sys-libs/readline:=
@@ -51,6 +50,7 @@
        gnutls? ( dev-libs/libgcrypt:0
                >=net-libs/gnutls-1.4.0 )
        ldap? ( net-nds/openldap )
+       system-heimdal? ( >=app-crypt/heimdal-1.5[-ssl] )
        systemd? ( sys-apps/systemd:0= )"
 DEPEND="${CDEPEND}
        virtual/pkgconfig"
@@ -108,11 +108,12 @@
                --disable-rpath-install \
                --nopyc \
                --nopyo \
-               --bundled-libraries=NONE \
+               --bundled-libraries=$(usex system-heimdal "NONE" "heimdal,!tdb,!talloc,!pytalloc-util,!tevent,!popt,!ldb,!pyldb-util,!zlib") \
                --builtin-libraries=NONE \
                $(use_with addns dnsupdate) \
                $(use_with acl acl-support) \
                $(use_with ads) \
+               $(usex ads "--with-shared-modules=idmap_ad" "") \
                $(use_with aio aio-support) \
                $(use_enable avahi) \
                $(use_with cluster cluster-support) \
@@ -127,9 +128,7 @@
                $(use_with quota quotas) \
                $(use_with syslog) \
                $(use_with systemd) \
-               $(use_with winbind)
-               "
-       use "ads" && myconf+=" --with-shared-modules=idmap_ad"
+               $(use_with winbind)"
 
        CPPFLAGS="-I/usr/include/et ${CPPFLAGS}" \
                waf-utils_src_configure ${myconf}